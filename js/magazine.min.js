/*
 * This plugin Manage the magazine
 * Author: Diana De Vargas Soler
 * Author URI: 
 * Version: 1.0
 * images url in data-src to lazy loading
 */(function(e,t,n){function d(n){var r=n||t.event,i=[].slice.call(arguments,1),s=0,o=!0,u=0,a=0;n=e.event.fix(r);n.type="mousewheel";r.wheelDelta&&(s=r.wheelDelta/120);r.detail&&(s=-r.detail/3);a=s;if(r.axis!==undefined&&r.axis===r.HORIZONTAL_AXIS){a=0;u=-1*s}r.wheelDeltaY!==undefined&&(a=r.wheelDeltaY/120);r.wheelDeltaX!==undefined&&(u=-1*r.wheelDeltaX/120);i.unshift(n,s,u,a);return(e.event.dispatch||e.event.handle).apply(this,i)}var r=e(t),i=e(n),s=null,o=0,u=2/3,a=2e3,f=!1,l=!1,c=!1,h=!1,p=["DOMMouseScroll","mousewheel"];e.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var e=p.length;e;)this.addEventListener(p[--e],d,!1);else this.onmousewheel=d},teardown:function(){if(this.removeEventListener)for(var e=p.length;e;)this.removeEventListener(p[--e],d,!1);else this.onmousewheel=null}};e.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}});e.fn.scrollThisElement=function(){this.off("mousewheel.scrollThisElement DOMMouseScroll.scrollThisElement").on("mousewheel.scrollThisElement DOMMouseScroll.scrollThisElement",function(t,n,r,i){var s=typeof n=="undefined";if(s)var n=t.originalEvent.wheelDelta||-t.originalEvent.detail;else{var o=e(this).scrollTop();e(this).scrollTop(o-Math.round(n*20))}if(e(this).data("page")===c){var u=Math.round(h.height()*1/100+1);e(this).scrollTop()>u?e(this).scrollTop()>=this.scrollHeight-e(this).innerHeight()?e(this).css("border-top-width",u+"px").css("border-bottom-width","0"):e(this).css("border-top-width",u+"px").css("border-bottom-width",u+"px"):e(this).css("border-top-width","0").css("border-bottom-width",u+"px")}if(s){if(n<0&&e(this).scrollTop()>=this.scrollHeight-e(this).innerHeight()){t.preventDefault();return}}else t.preventDefault();return!0});this.off("keydown.scrollThisElement").on("keydown.scrollThisElement",function(t){if(t.which===40&&e(this).scrollTop()>=this.scrollHeight-e(this).innerHeight()){t.preventDefault();return}if(t.which===106){alert("Hi there");return!0}return!0})};e.fn.scrollParent=function(){this.off("mousewheel.scrollThisElement DOMMouseScroll.scrollThisElement");this.off("keydown.scrollThisElement")};e.fn.dontScrollSideways=function(){this.off("mousewheel.noScrollSideways DOMMouseScroll.noScrollSideways").on("mousewheel.noScrollSideways DOMMouseScroll.noScrollSideways",function(t){var n=t.originalEvent.wheelDelta||-t.originalEvent.detail;if(n<0&&e(this).scrollLeft()>0){t.preventDefault();e(this).scrollLeft(0);return}return!0})};e.fn.scrollSideways=function(){this.off("mousewheel.noScrollSideways DOMMouseScroll.noScrollSideways")};e.fn.magazine=function(n){function b(){y.container.append('<section id="viewZone"><div id="magazineDesk" class="desk"><div class="magazine_help">Click on the top (right/left) corner to flip the page</div><div id="innerHolder"><div id="magazineHolder"><div id="magazine" class="'+(y.hardcover?"book":"soft")+'"></div>'+"</div>"+"</div>"+"</div>"+"</section>");s=e("#magazine")}function w(t){var n=typeof t=="undefined"?!0:!1;t=typeof t=="undefined"?"":t;if(s!==null){var r=e("#magazine .leaf").length+1,i=r*10,u=(r-1)*2+1,a=o*10-r*10,f='<div class="leaf" data-leaf="'+r+'" style="z-index:'+a+'" data-leftindex="'+i+'" data-rightindex="'+a+'" data-rpageindex="'+(a+1)+'">'+'<div class="right_page_rotator" style="z-index:'+(a+1)+'">'+'<div class="right_page_holder">'+'<div class="right_page" data-page="'+u+'">'+'<div class="right_page_gradient"></div>'+"</div>"+"</div>"+"</div>"+'<div class="left_page_rotator" style="z-index:inherit">'+'<div class="left_page_holder">'+'<div class="left_page" data-page="'+(u+1)+'">'+'<div class="left_page_gradient"></div>'+"</div>"+"</div>"+"</div>"+'<div class="shadow_holder">'+'<div class="rp_shadow_rotator">'+'<div class="rp_shadow_gradient"></div>'+"</div>"+'<div class="shadow_rotator">'+'<div class="shadow_gradient shadow_opacity"></div>'+"</div>"+"</div>"+'<div class="flip_corner" style="z-index:'+(a+3)+'"></div>'+"</div>",l='<div class="leaf hard_cover '+t+'" data-leaf="'+r+'" style="z-index:'+a+'" data-leftindex="'+i+'" data-rightindex="'+a+'">'+'<div class="hard_cover_rotator">'+'<div class="right_cover_holder" style="z-index:inherit">'+'<div class="right_page" data-page="'+u+'">'+'<div class="right_page_gradient"></div>'+"</div>"+"</div>"+'<div class="left_cover_holder" style="z-index:inherit">'+'<div class="left_page" data-page="'+(u+1)+'">'+'<div class="left_page_gradient"></div>'+"</div>"+"</div>"+"</div>"+'<div class="flip_corner" style="z-index:'+(a+3)+'"></div>'+"</div>",c=n?e(f):e(l);s.append(c);return c}}function E(e,t,n,r){var i=e.length>0?e.detach():"",s=i.length>0?i.data("title"):"",o=i.length>0?i.data("image"):"",a=i.length>0?i.data("type"):"",f;s=typeof s=="undefined"||s===!1||s.length===0?"":s;o=typeof o=="undefined"||o===!1||o.length===0?"":o;switch(n){case"l":f=t.find(".left_page");f.data("title",s?s:"Page "+f.data("page")).data("image",o).data("type",a);i.length>0&&f.prepend(i);u++;break;case"r":f=t.find(".right_page");f.data("title",s?s:"Page "+f.data("page")).data("image",o).data("type",a);i.length>0&&f.prepend(i);u++;break;case"b":f=t.find(".left_page");f.data("title",s?s+" 1":"Page "+f.data("page")).data("image",o).data("type",a);i.length>0&&f.prepend(i);u++;f=r.find(".right_page");f.data("title",s?s+" 2":"Page "+f.data("page")).data("image",o).data("type",a);i.length>0&&f.prepend(i.clone());u++}}function S(){e("#magazine .flip_corner").hover(function(t){t.preventDefault();e(this).parent(".leaf").addClass("show_corner")},function(t){t.preventDefault();e(this).parent(".leaf").removeClass("show_corner")});e("#magazine .flip_corner").click(function(n){if(typeof n.pageX!="undefined"&&e.manageMagazine.isFlipping())return;var r=e(this),i=r.parent(".leaf"),s=i.data("leaf"),o=!i.hasClass("flip_left");typeof n.pageX!="undefined"&&e.manageMagazine.flipOn(r);e.manageMagazine.changeIndex(i,"f");if(o){i.addClass("show_page flip_left");typeof n.pageX!="undefined"&&e.manageMagazine.loadPage(i.find(".left_page"));t.setTimeout(e.manageMagazine.changeIndex,a,i,"l")}else{typeof n.pageX!="undefined"&&e.manageMagazine.loadPage(i.find(".right_page"));i.removeClass("on_left").removeClass("flip_left");t.setTimeout(e.manageMagazine.changeIndex,a,i,"r","show_page")}typeof n.pageX!="undefined"&&t.setTimeout(e.manageMagazine.flipOff,a)});y.load&&s.find("div[data-page]").on("magLoadPage.loadPageImages",function(t){if(e(this).attr("loaded")!=="yes"){e(this).find("img").each(function(){var t=e(this).data("src");typeof t!="undefined"&&t!==!1&&e(this).attr("src",t)});e(this).attr("loaded","yes")}});y.unload&&s.find("div[data-page]").on("magUnloadPage.unloadPageImages",function(t){if(e(this).attr("loaded")==="yes"){e(this).find("img").each(function(){e(this).attr("src","")});e(this).attr("loaded","no")}});e("body").dontScrollSideways();s.find(".left_page").scrollThisElement();s.find(".right_page").scrollThisElement()}function x(){u=0;var t=e("<"+y.contentMarkup.wrapperTag+' id="magazineIndex" data-title="content" data-type="content" class="'+y.contentMarkup.wrapperClass+'">'+"<"+y.contentMarkup.titleTag+' class="'+y.contentMarkup.titleClass+'">Content</'+y.contentMarkup.titleTag+">"+"<"+y.contentMarkup.groupTag+' class="'+y.contentMarkup.groupClass+'"></'+y.contentMarkup.groupTag+">"+"</"+y.contentMarkup.wrapperTag+">");if(y.hardcover){p=w("front_cover");f=p.data("leaf");d?E(d.data("title","Cover"),p,"r"):E(e('<div data-title="Cover" data-type="frontcover"></div>'),p,"r");E(e('<div data-title="" data-type="frontflap"></div>'),p,"l");p=w();E(e('<div data-title="" data-type="endpaper"></div>'),p,"r");E(e('<div data-title="" data-type="endpaper"></div>'),p,"l");p=w();E(t,p,"r");E(e('<div data-title="" data-type="endpaper"></div>'),p,"l");g=p.find(".right_page")}else{p=w();f=p.data("leaf");d?E(d.data("title","Cover"),p,"r"):E(e('<div data-title="Cover" data-type="frontcover"></div>'),p,"r");E(t,p,"l");g=p.find(".left_page")}c=g.data("page");h=g.parent();m=g.find("#magazineIndex "+y.contentMarkup.groupTag);i.each(function(){var t=e(this),n=t.data("type")==="double";if(t.data("type")!=="double"&&t.data("type")!=="single")return;if(n){if(u%2===0){p=w();E("",p,"r")}var r=w();E(t,p,"b",r);p=r}else if(u%2===0){p=w();E(t,p,"r")}else E(t,p,"l")});if(y.hardcover){u%2!==0&&E(e('<div data-title=""  data-type="endpaper"></div>'),p,"l");p=w();E(e('<div data-title="" data-type="endpaper"></div>'),p,"r");E(e('<div data-title="" data-type="endpaper"></div>'),p,"l");p=w("back_cover");E(e('<div data-title="backflap" data-type="backflap"></div>'),p,"r");if(v){v.data("title","Back Cover");E(v,p,"l")}else E(e('<div data-title="Back Cover" data-type="backcover"></div>'),p,"l")}else{v?v.data("title","Back Cover"):v=e('<div data-title="Back Cover" data-type="backcover"></div>');if(u%2===0){p=w();E(v.clone(),p,"r")}E(v,p,"l")}l=p.data("leaf");var n=l>1?l-1:1;e("#magazine .leaf[data-leaf='"+n+"']").addClass("last_shadow")}function T(){var t=e.manageMagazine.getIndex();e.each(t,function(e,t){var n=t.title==="Page "+t.pageNo?'<span class="title"></span>':'<span class="title">'+t.title+"</span>",r=t.image.length>0?'<img src="'+t.image+'" class="img-rounded" alt="'+t.title+'">':"";m.append("<"+y.contentMarkup.itemTag+' class="'+y.contentMarkup.itemClass+'"><a href="#" class="magazine_link" data-page="'+t.pageNo+'">'+r+n+'<span class="pagenumber">'+t.pageNo+"</span></a></"+y.contentMarkup.itemTag+">")});m.find("a.magazine_link").click(function(t){t.preventDefault();e.manageMagazine.goToPage(e(this).data("page"))})}var i=e(this),u=0,p=null,d=!1,v=!1,m=!1,g=!1,y={container:e("body"),load:!1,unload:!1,hardcover:!0,contentMarkup:{titleTag:"h2",titleClass:"",wrapperTag:"div",wrapperClass:"",groupTag:"ul",groupClass:"stacked",itemTag:"li",itemClass:""}};n&&(y=e.extend(y,n));i.each(function(){switch(e(this).data("type")){case"frontcover":d=e(this).detach();break;case"backcover":v=e(this).detach();break;case"double":o+=o%2===0?2:3;break;default:o++}});o+=y.hardcover?10:4;b();x();T();S();e.manageMagazine.loadPage(1);r.resize(function(){e.manageMagazine.magazineResize(y.container)}).on("orientationchange",function(){e.manageMagazine.magazineResize(y.container)}).resize();y.container.trigger("magazineCreated")};e.manageMagazine=function(){var n=!1,f=!1,l=!1,h=10,p=!0,d=0,v=!0,m={loadThreshold:20,magHldMrgOut:"10%",magHldMrgIn:"0%"},g=function(t,n){var r="",i="",s,u,a;n=typeof n=="undefined"?0:n*1;if(typeof t=="object"&&t!==null){t.hasClass("right_page")&&(r=t);t.hasClass("left_page")&&(i=t);s=t.data("page")*1}else{s=t*1;if(s<1||s>o)return;r=e("#magazine .right_page[data-page='"+s+"']");i=e("#magazine .left_page[data-page='"+s+"']")}if(r.length>0){r.trigger("magLoadPage");if(n===0){u=s-1-m.loadThreshold<1?1:s-1-m.loadThreshold;a=s+m.loadThreshold>o?o:s+m.loadThreshold}}else if(i.length>0){i.trigger("magLoadPage");if(n===0){u=s-m.loadThreshold<1?1:s-m.loadThreshold;a=s+1+m.loadThreshold>o?o:s+1+m.loadThreshold}}if((r.length>0||i.length>0)&&n===0){var f;for(f=1;f<s;f++)f<u?y(f,++n):g(f,++n);for(f=s+1;f<=o;f++)f<=a?g(f,++n):y(f,++n)}},y=function(t,n){var r="",i="",s;n=typeof n=="undefined"?0:n*1;if(typeof t=="object"&&t!==null){t.hasClass("right_page")&&(r=t);t.hasClass("left_page")&&(i=t);s=t.data("page")*1}else{s=t*1;if(s<1||s>o)return;r=e("#magazine .right_page[data-page='"+s+"']");i=e("#magazine .left_page[data-page='"+s+"']")}if(r.length>0){r.trigger("magUnloadPage");n===0&&y(s-1,n+1)}else if(i.length>0){i.trigger("magUnloadPage");n===0&&y(s+1,n+1)}},b=function(n,r,i){var s,u,f,c,h;n*=1;r=typeof r=="undefined"?10:r*1;i=typeof i=="undefined"?0:i*1;if(i===0&&l)return;if(n<1||n>o)return r;l=!0;var p=e("#magazine .right_page[data-page='"+n+"']"),d=e("#magazine .left_page[data-page='"+n+"']"),v=p.length>0,m=v?p:d;if(m.length>0){s=m.closest(".leaf");i===0&&g(m);if(s.hasClass("flip_left")){c=s.data("leaf")*1+1;u=e("#magazine .leaf[data-leaf='"+c+"']");if(u.length>0&&u.hasClass("flip_left")){h=v?n+2:n+1;r=b(h,r,i+1)}if(v){t.setTimeout(e.manageMagazine.flipCorner,r,s);r+=a+5}}else{c=s.data("leaf")*1-1;f=e("#magazine .leaf[data-leaf='"+c+"']");if(f.length>0&&!f.hasClass("flip_left")){h=v?n-1:n-2;r=b(n-1,r,i+1)}if(!v){s.addClass("show_page");t.setTimeout(e.manageMagazine.flipCorner,r,s);r+=a+5}}}i===0&&t.setTimeout(e.manageMagazine.goingEnd,r);return r},w=function(){var t=[],n=0,r=["content","frontflap","backflap","endpaper"];s!==null&&s.find("div[data-page]").each(function(){var i=e(this);if(r.indexOf(i.data("type"))===-1&&i.data("page")<=o){t[n]={title:i.data("title"),pageNo:i.data("page"),image:i.data("image")};n++}});return t};return{init:function(t){m=e.extend(m,t);h=parseInt(m.magHldMrgOut);p=m.magHldMrgOut.indexOf("%")!==-1;d=parseInt(m.magHldMrgIn);v=m.magHldMrgIn.indexOf("%")!==-1},goingEnd:function(){l=!1},isFlipping:function(){return n},flipOn:function(e){f=e.addClass("active");n=!0},flipOff:function(){f.removeClass("active");n=!1},loadPage:function(e,t){g(e,t)},unloadPage:function(e,t){y(e,t)},flipCorner:function(e){e.children(".flip_corner").click()},changeIndex:function(t,n,r){typeof r!="undefined"&&e.manageMagazine.removeMyClass(t,r);var i=n==="l"?t.data("leftindex"):t.data("rightindex");t.children(".flip_corner").css("z-index",i+3);t.css("z-index",i);n==="l"&&t.addClass("on_left");if(t.hasClass("hard_cover"))return;if(n==="f"){t.children(".right_page_rotator").css("z-index",i+1);t.children(".left_page_rotator").css("z-index",i+2)}else if(n==="l"){t.children(".right_page_rotator").css("z-index","inherit");t.children(".left_page_rotator").css("z-index","inherit")}else{t.children(".right_page_rotator").css("z-index",i+1);t.children(".left_page_rotator").css("z-index","inherit")}},removeMyClass:function(e,t,n){e.removeClass(t);typeof n!="undefined"&&e.addClass(n)},goToPage:function(e,t,n){return b(e,t,n)},goToContentPage:function(){b(c)},getIndex:function(){return w()},magazineResize:function(t){var n=r.height()-(p?r.height()*h/100:h)-(v?r.height()*d/100:d),s=t.width()>0?t.width():r.width(),o=Math.round(n/u)*2,a=o<s?Math.round(o*100/s):100;e("#viewZone").css("width",a+"%");i.trigger("magazineResizeFinish")}}}()})(jQuery,window,document);