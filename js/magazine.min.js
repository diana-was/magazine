/*
 * This plugin Manage the magazine
 * 
 * images url in data-src to lazy loading
 */(function(e,t,n){var r=e(t),i=e(n),s=null,o=0,u=2/3,a=2e3,f=!1,l=!1,c=!1;e.fn.magazine=function(n){function y(){g.container.append('<section id="viewZone"><div id="magazineDesk" class="desk"><div class="magazine_help">Click on the top (right/left) corner to flip the page</div><div id="imageHolder"><div id="magazineHolder"><div id="magazine" class="'+(g.hardcover?"book":"soft")+'"></div>'+"</div>"+"</div>"+"</div>"+"</section>");s=e("#magazine");u=e("#imageHolder")}function b(t){var n=typeof t=="undefined"?!0:!1;t=typeof t=="undefined"?"":t;if(s!==null){var r=e("#magazine .leaf").length+1,i=r*10,u=(r-1)*2+1,a=o*10-r*10,f='<div class="leaf" data-leaf="'+r+'" style="z-index:'+a+'" data-leftindex="'+i+'" data-rightindex="'+a+'" data-rpageindex="'+(a+1)+'">'+'<div class="right_page_rotator" style="z-index:'+(a+1)+'">'+'<div class="right_page_holder">'+'<div class="right_page" data-page="'+u+'">'+'<div class="right_page_gradient"></div>'+"</div>"+"</div>"+"</div>"+'<div class="left_page_rotator">'+'<div class="left_page_holder">'+'<div class="left_page" data-page="'+(u+1)+'">'+'<div class="left_page_gradient"></div>'+"</div>"+"</div>"+"</div>"+'<div class="shadow_holder">'+'<div class="rp_shadow_rotator">'+'<div class="rp_shadow_gradient"></div>'+"</div>"+'<div class="shadow_rotator">'+'<div class="shadow_gradient shadow_opacity"></div>'+"</div>"+"</div>"+'<div class="flip_corner" style="z-index:'+(a+2)+'"></div>'+"</div>",l='<div class="leaf hard_cover '+t+'" data-leaf="'+r+'" style="z-index:'+a+'" data-leftindex="'+i+'" data-rightindex="'+a+'" data-rpageindex="'+(a+1)+'">'+'<div class="hard_cover_rotator">'+'<div class="right_cover_holder" style="z-index:'+(a+1)+'">'+'<div class="right_page" data-page="'+u+'">'+'<div class="right_page_gradient"></div>'+"</div>"+"</div>"+'<div class="left_cover_holder">'+'<div class="left_page" data-page="'+(u+1)+'">'+'<div class="left_page_gradient"></div>'+"</div>"+"</div>"+"</div>"+'<div class="flip_corner" style="z-index:'+(a+2)+'"></div>'+"</div>",c=n?e(f):e(l);s.append(c);return c}}function w(e,t,n,r){var i=e.length>0?e.detach():"",s=i.length>0?i.data("title"):"",o=i.length>0?i.data("image"):"",u=i.length>0?i.data("type"):"",a;s=typeof s=="undefined"||s===!1||s.length===0?"":s;o=typeof o=="undefined"||o===!1||o.length===0?"":o;switch(n){case"l":a=t.find(".left_page");a.data("title",s?s:"Page "+a.data("page"));a.data("image",o);a.data("type",u);i.length>0&&a.prepend(i);h++;break;case"r":a=t.find(".right_page");a.data("title",s?s:"Page "+a.data("page"));a.data("image",o);a.data("type",u);i.length>0&&a.prepend(i);h++;break;case"b":a=t.find(".left_page");a.data("title",s?s+" 1":"Page "+a.data("page"));a.data("image",o);a.data("type",u);i.length>0&&a.prepend(i);h++;a=r.find(".right_page");a.data("title",s?s+" 2":"Page "+a.data("page"));a.data("image",o);a.data("type",u);i.length>0&&a.prepend(i.clone());h++}}function E(){e("#magazine .flip_corner").hover(function(t){t.preventDefault();e(this).parent(".leaf").addClass("show_corner")},function(t){t.preventDefault();e(this).parent(".leaf").removeClass("show_corner")});e("#magazine .flip_corner").click(function(n){if(typeof n.pageX!="undefined"&&e.manageMagazine.isFlipping())return;var r=e(this),i=r.parent(".leaf"),s=i.data("leaf"),o=!i.hasClass("flip_left");typeof n.pageX!="undefined"&&e.manageMagazine.flipOn(r);i.find(".right_page_rotator").css("z-index","initial");i.css("z-index",i.data("rightindex"));if(o){typeof n.pageX!="undefined"&&e.manageMagazine.loadPage(i.find(".left_page"));i.addClass("show_page").addClass("flip_left");t.setTimeout(e.manageMagazine.changeIndex,a,i,"l")}else{typeof n.pageX!="undefined"&&e.manageMagazine.loadPage(i.find(".right_page"));i.removeClass("on_left").removeClass("flip_left");t.setTimeout(e.manageMagazine.removeMyClass,a,i,"show_page");t.setTimeout(e.manageMagazine.changeIndex,a,i,"r")}typeof n.pageX!="undefined"&&t.setTimeout(e.manageMagazine.flipOff,a)});g.load&&s.find("div[data-page]").on("magLoadPage.loadPageImages",function(t){if(e(this).attr("loaded")!=="yes"){e(this).find("img").each(function(){var t=e(this).data("src");typeof t!="undefined"&&t!==!1&&e(this).attr("src",t)});e(this).attr("loaded","yes")}});g.unload&&s.find("div[data-page]").on("magUnloadPage.unloadPageImages",function(t){if(e(this).attr("loaded")==="yes"){e(this).find("img").each(function(){e(this).attr("src","")});e(this).attr("loaded","no")}})}function S(){h=0;if(g.hardcover){p=b("front_cover");f=p.data("leaf");d?w(d.data("title","Cover"),p,"r"):w(e('<div data-title="Cover" data-type="frontcover"></div>'),p,"r");w(e('<div data-title="" data-type="frontflap"></div>'),p,"l");p=b();w(e('<div data-title="" data-type="endpaper"></div>'),p,"r");w(e('<div data-title="" data-type="endpaper"></div>'),p,"l");p=b();w(e("<"+g.contentMarkup.wrapperTag+' id="magazineIndex" data-title="content" data-type="content" class="'+g.contentMarkup.wrapperClass+'">'+"<"+g.contentMarkup.titleTag+' class="'+g.contentMarkup.titleClass+'">Content</'+g.contentMarkup.titleTag+">"+"<"+g.contentMarkup.groupTag+' class="'+g.contentMarkup.groupClass+'"></'+g.contentMarkup.groupTag+">"+"</"+g.contentMarkup.wrapperTag+">"),p,"r");w(e('<div data-title="" data-type="endpaper"></div>'),p,"l");m=p.find("#magazineIndex "+g.contentMarkup.groupTag);c=p.find(".right_page").data("page")}else{p=b();f=p.data("leaf");d?w(d.data("title","Cover"),p,"r"):w(e('<div data-title="Cover" data-type="frontcover"></div>'),p,"r");w(e("<"+g.contentMarkup.wrapperTag+' id="magazineIndex" data-title="content" data-type="content" class="'+g.contentMarkup.wrapperClass+'">'+"<"+g.contentMarkup.titleTag+' class="'+g.contentMarkup.titleClass+'">Content</'+g.contentMarkup.titleTag+">"+"<"+g.contentMarkup.groupTag+' class="'+g.contentMarkup.groupClass+'"></'+g.contentMarkup.groupTag+">"+"</"+g.contentMarkup.wrapperTag+">"),p,"l");m=p.find("#magazineIndex "+g.contentMarkup.groupTag);c=p.find(".left_page").data("page")}i.each(function(){var t=e(this),n=t.data("type")==="double";if(t.data("type")!=="double"&&t.data("type")!=="single")return;if(n){if(h%2===0){p=b();w("",p,"r")}var r=b();w(t,p,"b",r);p=r}else if(h%2===0){p=b();w(t,p,"r")}else w(t,p,"l")});if(g.hardcover){h%2!==0&&w(e('<div data-title=""  data-type="endpaper"></div>'),p,"l");p=b();w(e('<div data-title="" data-type="endpaper"></div>'),p,"r");w(e('<div data-title="" data-type="endpaper"></div>'),p,"l");p=b("back_cover");w(e('<div data-title="backflap" data-type="backflap"></div>'),p,"r");if(v){v.data("title","Back Cover");w(v,p,"l")}else w(e('<div data-title="Back Cover" data-type="backcover"></div>'),p,"l")}else{v?v.data("title","Back Cover"):v=e('<div data-title="Back Cover" data-type="backcover"></div>');if(h%2===0){p=b();w(v.clone(),p,"r")}w(v,p,"l")}l=p.data("leaf");var t=l>1?l-1:1;e("#magazine .leaf[data-leaf='"+t+"']").addClass("last_shadow")}function x(){var t=e.manageMagazine.getIndex();e.each(t,function(e,t){var n=t.title==="Page "+t.pageNo?'<span class="title"></span>':'<span class="title">'+t.title+"</span>",r=t.image.length>0?'<img src="'+t.image+'" class="img-rounded" alt="'+t.title+'">':"";m.append("<"+g.contentMarkup.itemTag+' class="'+g.contentMarkup.itemClass+'"><a href="#" class="magazine_link" data-page="'+t.pageNo+'">'+r+n+'<span class="pagenumber">'+t.pageNo+"</span></a></"+g.contentMarkup.itemTag+">")});m.find("a.magazine_link").click(function(t){t.preventDefault();e.manageMagazine.goToPage(e(this).data("page"))})}var i=e(this),u=null,h=0,p=null,d=!1,v=!1,m=!1,g={container:e("body"),load:!1,unload:!1,hardcover:!0,contentMarkup:{titleTag:"h2",titleClass:"",wrapperTag:"div",wrapperClass:"",groupTag:"ul",groupClass:"stacked",itemTag:"li",itemClass:""}};n&&(g=e.extend(g,n));i.each(function(){switch(e(this).data("type")){case"frontcover":d=e(this).detach();break;case"backcover":v=e(this).detach();break;case"double":o+=o%2===0?2:3;break;default:o++}});if(o>0){o+=g.hardcover?10:4;y();S();x();E();e.manageMagazine.loadPage(1);r.resize(function(){e.manageMagazine.getMagResize(g.container)}).on("orientationchange",function(){e.manageMagazine.getMagResize(g.container)}).resize()}else s=e("<div></div>")};e.manageMagazine=function(){var n=!1,f=!1,l=10,h=!0,p=0,d=!0,v={loadThreshold:20,magHldMrgOut:"10%",magHldMrgIn:"0%"},m=function(t,n){var r="",i="",s,u,a;n=typeof n=="undefined"?0:n*1;if(typeof t=="object"&&t!==null){t.hasClass("right_page")&&(r=t);t.hasClass("left_page")&&(i=t);s=t.data("page")*1}else{s=t*1;if(s<1||s>o)return;r=e("#magazine .right_page[data-page='"+s+"']");i=e("#magazine .left_page[data-page='"+s+"']")}if(r.length>0){r.trigger("magLoadPage");if(n===0){u=s-1-v.loadThreshold<1?1:s-1-v.loadThreshold;a=s+v.loadThreshold>o?o:s+v.loadThreshold}}else if(i.length>0){i.trigger("magLoadPage");if(n===0){u=s-v.loadThreshold<1?1:s-v.loadThreshold;a=s+1+v.loadThreshold>o?o:s+1+v.loadThreshold}}if((r.length>0||i.length>0)&&n===0){var f;for(f=1;f<s;f++)f<u?g(f,++n):m(f,++n);for(f=s+1;f<=o;f++)f<=a?m(f,++n):g(f,++n)}},g=function(t,n){var r="",i="",s;n=typeof n=="undefined"?0:n*1;if(typeof t=="object"&&t!==null){t.hasClass("right_page")&&(r=t);t.hasClass("left_page")&&(i=t);s=t.data("page")*1}else{s=t*1;if(s<1||s>o)return;r=e("#magazine .right_page[data-page='"+s+"']");i=e("#magazine .left_page[data-page='"+s+"']")}if(r.length>0){r.trigger("magUnloadPage");n===0&&g(s-1,n+1)}else if(i.length>0){i.trigger("magUnloadPage");n===0&&g(s+1,n+1)}},y=function(n,r,i){var s,u,f,l;n*=1;r=typeof r=="undefined"?0:r*1;i=typeof i=="undefined"?0:i*1;if(n<1||n>o)return r;var c=e("#magazine .right_page[data-page='"+n+"']"),h=e("#magazine .left_page[data-page='"+n+"']");if(c.length>0){s=c.closest(".leaf");i===0&&m(c);if(s.hasClass("flip_left")){l=s.data("leaf")*1+1;u=e("#magazine .leaf[data-leaf='"+l+"']");u.length>0&&u.hasClass("flip_left")&&(r=y(n+2,r,i+1));t.setTimeout(e.manageMagazine.flipCorner,r,s);r+=a}else{l=s.data("leaf")*1-1;f=e("#magazine .leaf[data-leaf='"+l+"']");f.length>0&&!f.hasClass("flip_left")&&(r=y(n-1,r,i+1))}}else if(h.length>0){s=h.closest(".leaf");i===0&&m(h);if(s.hasClass("flip_left")){l=s.data("leaf")*1+1;u=e("#magazine .leaf[data-leaf='"+l+"']");u.length>0&&u.hasClass("flip_left")&&(r=y(n+1,r,i+1))}else{l=s.data("leaf")*1-1;f=e("#magazine .leaf[data-leaf='"+l+"']");f.length>0&&!f.hasClass("flip_left")&&(r=y(n-2,r,i+1));t.setTimeout(e.manageMagazine.flipCorner,r,s);s.addClass("show_page");r+=a}}return r},b=function(){var t=[],n=0,r=["content","frontflap","backflap","endpaper"];s!==null&&s.find("div[data-page]").each(function(){var i=e(this);if(r.indexOf(i.data("type"))===-1&&i.data("page")<=o){t[n]={title:i.data("title"),pageNo:i.data("page"),image:i.data("image")};n++}});return t};return{init:function(t){v=e.extend(v,t);l=parseInt(v.magHldMrgOut);h=v.magHldMrgOut.indexOf("%")!==-1;p=parseInt(v.magHldMrgIn);d=v.magHldMrgIn.indexOf("%")!==-1},isFlipping:function(){return n},flipOn:function(e){f=e.addClass("active");n=!0},flipOff:function(){f.removeClass("active");n=!1},loadPage:function(e,t){m(e,t)},unloadPage:function(e,t){g(e,t)},flipCorner:function(e){e.children(".flip_corner").click()},changeIndex:function(e,t){if(t==="l"){e.css("z-index",e.data("leftindex"));e.addClass("on_left")}else{e.find(".right_page_rotator").css("z-index",e.data("rpageindex"));e.css("z-index",e.data("rightindex"))}},removeMyClass:function(e,t,n){e.removeClass(t);typeof n!="undefined"&&e.addClass(n)},goToPage:function(e,t,n){return y(e,t,n)},goToContentPage:function(){y(c)},getIndex:function(){return b()},getMagResize:function(t){var n=r.height()-(h?r.height()*l/100:l)-(d?r.height()*p/100:p),s=t.width()>0?t.width():r.width(),o=Math.round(n/u)*2,a=o<s?Math.round(o*100/s):100;e("#viewZone").css("width",a+"%");i.trigger("magazineResize")}}}()})(jQuery,window,document);